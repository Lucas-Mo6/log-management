<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenSearch æ—¥å¿—ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary-color: #1890ff;
            --secondary-color: #f0f2f5;
            --border-color: #d9d9d9;
            --text-color: #333;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --error-color: #ff4d4f;
            --info-color: #1890ff;
            --dark-bg: #2c3e50;
            --light-bg: #ffffff;
            --sidebar-width: 300px;
            --header-height: 60px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--secondary-color);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), #0050b3);
            color: white;
            padding: 0 20px;
            height: var(--header-height);
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--light-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
        }

        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .search-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
            color: #555;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            font-weight: 500;
        }

        button:hover {
            background-color: #40a9ff;
        }

        .btn-block {
            display: block;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-secondary {
            background-color: #d9d9d9;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #bfbfbf;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #73d13d;
        }

        .logs-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--light-bg);
            overflow: hidden;
        }

        .logs-header {
            padding: 15px 20px;
            background-color: var(--light-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logs-count {
            font-weight: 600;
            color: var(--primary-color);
        }

        .logs-actions {
            display: flex;
            gap: 10px;
        }

        .logs-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .log-entry {
            padding: 2px 8px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.3;
            /* å‡å°è¡Œé«˜ï¼Œè®©æ—¥å¿—æ›´ç´§å‡‘ */
        }

        .log-entry:hover {
            background-color: #f5f5f5;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1px;
            font-size: 12px;
        }

        .log-timestamp {
            color: #888;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .log-metadata {
            color: #888;
        }

        .json-btn {
            background-color: #1890ff;
            color: white;
            border: none;
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .json-btn:hover {
            background-color: #40a9ff;
        }

        .log-content {
            /* white-space: pre-wrap; */
            word-break: break-word;
            padding: 1px 4px;
            border-radius: 4px;
            background-color: #fafafa;
            border-left: 3px solid var(--primary-color);
            margin-top: 0;
            overflow-x: auto;
            font-family: 'Menlo', 'Monaco', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.3;
            /* å‡å°è¡Œé«˜ */
        }

        .log-content p {
            margin: 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.3;
            /* å‡å°è¡Œé«˜ */
        }

        .log-level-info {
            border-left-color: var(--info-color);
        }

        .log-level-warning {
            border-left-color: var(--warning-color);
        }

        .log-level-error {
            border-left-color: var(--error-color);
        }

        .log-level-debug {
            border-left-color: #999;
        }

        /* æœç´¢è¯é«˜äº® */
        .highlight {
            background-color: #ffeb3b;
            padding: 1px 2px;
            border-radius: 2px;
        }

        /* MyBatis æ—¥å¿—æŠ˜å æ ·å¼ */
        .mybatis-container {
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            margin: 0;
            background-color: #f9f9f9;
            overflow: hidden;
        }

        .mybatis-header {
            padding: 2px 6px;
            background-color: #f0f0f0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #0066cc;
            font-weight: 500;
            user-select: none;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .mybatis-header-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .mybatis-header:hover {
            background-color: #e8e8e8;
        }

        .mybatis-toggle {
            font-size: 9px;
            color: #999;
            margin-left: 5px;
        }

        .mybatis-content {
            padding: 3px 6px;
            display: none;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .mybatis-content.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ddd;
        }

        .empty-state p {
            font-size: 16px;
        }

        #customTimeRange {
            display: none;
        }

        .export-options {
            display: flex;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .export-options {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header>
            <h1>OpenSearch æ—¥å¿—ç®¡ç†ç³»ç»Ÿ</h1>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <h2>ç­›é€‰æ¡ä»¶</h2>
                <form id="searchForm" class="search-form">
                    <div class="form-group">
                        <label for="indexPattern">ç´¢å¼•æ¨¡å¼</label>
                        <input type="text" id="indexPattern" value="kube-*" required>
                    </div>

                    <div class="form-group">
                        <label for="appName">åº”ç”¨åç§°</label>
                        <input type="text" id="appName" value="lab-service-cloud">
                    </div>

                    <div class="form-group">
                        <label for="searchTerm">æœç´¢å…³é”®è¯</label>
                        <input type="text" id="searchTerm" placeholder="è¾“å…¥è¦æœç´¢çš„æ—¥å¿—å†…å®¹">
                    </div>

                    <div class="form-group">
                        <label for="timeRange">æ—¶é—´èŒƒå›´</label>
                        <select id="timeRange">
                            <option value="1h">æœ€è¿‘1å°æ—¶</option>
                            <option value="6h">æœ€è¿‘6å°æ—¶</option>
                            <option value="12h" selected>æœ€è¿‘12å°æ—¶</option>
                            <option value="24h">æœ€è¿‘24å°æ—¶</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                    </div>

                    <div class="form-group" id="customTimeRange">
                        <label for="startTime">å¼€å§‹æ—¶é—´</label>
                        <input type="datetime-local" id="startTime">
                        <label for="endTime">ç»“æŸæ—¶é—´</label>
                        <input type="datetime-local" id="endTime">
                    </div>

                    <div class="form-group">
                        <label for="logType">æ—¥å¿—ç±»å‹</label>
                        <select id="logType">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="mybatis">MyBatisæ—¥å¿—</option>
                            <option value="application" selected>åº”ç”¨æ—¥å¿—(æ’é™¤MyBatis)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="maxResults">æœ€å¤§ç»“æœæ•°</label>
                        <select id="maxResults">
                            <option value="10">10</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="500">500</option>
                            <option value="1000">1000</option>
                        </select>
                    </div>

                    <button type="submit" class="btn-block">æœç´¢æ—¥å¿—</button>
                </form>

                <div style="margin-top: 30px;">
                    <h2>å¯¼å‡ºé€‰é¡¹</h2>
                    <div class="export-options">
                        <button id="exportTxtBtn" class="btn-secondary">å¯¼å‡ºä¸ºTXT</button>
                        <button id="exportJsonBtn" class="btn-secondary">å¯¼å‡ºä¸ºJSON</button>
                    </div>
                </div>
            </div>

            <div class="logs-container">
                <div class="logs-header">
                    <div class="logs-count">æ—¥å¿—è®°å½• (<span id="logCount">0</span>)</div>
                    <div class="logs-actions">
                        <button id="refreshBtn">åˆ·æ–°</button>
                    </div>
                </div>

                <div class="logs-list" id="logsList">
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“</div>
                        <p>è¯·è¾“å…¥ç­›é€‰æ¡ä»¶å¹¶ç‚¹å‡»"æœç´¢æ—¥å¿—"æŒ‰é’®æŸ¥çœ‹ç»“æœ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨å½“å‰æ—¥å¿—æ•°æ®
        let currentLogs = [];

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            // æ—¶é—´èŒƒå›´é€‰æ‹©äº‹ä»¶
            const timeRangeSelect = document.getElementById('timeRange');
            const customTimeRange = document.getElementById('customTimeRange');

            timeRangeSelect.addEventListener('change', function () {
                if (this.value === 'custom') {
                    customTimeRange.style.display = 'block';
                } else {
                    customTimeRange.style.display = 'none';
                }
            });

            // æœç´¢è¡¨å•æäº¤äº‹ä»¶
            const searchForm = document.getElementById('searchForm');
            searchForm.addEventListener('submit', function (e) {
                e.preventDefault();
                searchLogs();
            });

            // å¯¼å‡ºæŒ‰é’®äº‹ä»¶
            const exportTxtBtn = document.getElementById('exportTxtBtn');
            const exportJsonBtn = document.getElementById('exportJsonBtn');

            exportTxtBtn.addEventListener('click', function () {
                exportLogs('txt');
            });

            exportJsonBtn.addEventListener('click', function () {
                exportLogs('json');
            });

            // åˆ·æ–°æŒ‰é’®äº‹ä»¶
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.addEventListener('click', searchLogs);

            // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æœç´¢ä¸€æ¬¡
            // searchLogs();
        });

        // æœç´¢æ—¥å¿—å‡½æ•°
        async function searchLogs() {
            const logsList = document.getElementById('logsList');
            const logCount = document.getElementById('logCount');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            logsList.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨æœç´¢æ—¥å¿—...</p>
                </div>
            `;

            try {
                // è·å–è¡¨å•æ•°æ®
                const formData = {
                    indexPattern: document.getElementById('indexPattern').value,
                    appName: document.getElementById('appName').value,
                    searchTerm: document.getElementById('searchTerm').value,
                    timeRange: document.getElementById('timeRange').value,
                    maxResults: document.getElementById('maxResults').value,
                    logType: document.getElementById('logType').value
                };

                // å¦‚æœæ˜¯è‡ªå®šä¹‰æ—¶é—´èŒƒå›´
                if (formData.timeRange === 'custom') {
                    formData.startTime = document.getElementById('startTime').value;
                    formData.endTime = document.getElementById('endTime').value;
                }

                // å‘é€è¯·æ±‚åˆ°åç«¯API
                const response = await fetch('/api/search-logs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error(`æœç´¢å¤±è´¥: ${response.statusText}`);
                }

                const data = await response.json();

                // ä¿å­˜å½“å‰æ—¥å¿—æ•°æ®åˆ°å…¨å±€å˜é‡
                currentLogs = data.hits || [];

                // æ›´æ–°æ—¥å¿—è®¡æ•°
                logCount.textContent = currentLogs.length;

                // æ¸²æŸ“æ—¥å¿—åˆ—è¡¨
                if (currentLogs.length > 0) {
                    renderLogs(currentLogs);
                    // æ·»åŠ  MyBatis æ—¥å¿—æŠ˜å äº‹ä»¶ç›‘å¬å™¨
                    addMyBatisCollapseListeners();
                } else {
                    logsList.innerHTML = `
                        <div class="empty-state">
                            <div style="font-size: 48px; margin-bottom: 15px;">ğŸ”</div>
                            <p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ—¥å¿—è®°å½•</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('æœç´¢æ—¥å¿—æ—¶å‡ºé”™:', error);
                logsList.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 15px;">âŒ</div>
                        <p>æœç´¢å¤±è´¥: ${error.message}</p>
                    </div>
                `;
            }
        }

        // æ·»åŠ  MyBatis æ—¥å¿—æŠ˜å äº‹ä»¶ç›‘å¬å™¨
        function addMyBatisCollapseListeners() {
            document.querySelectorAll('.mybatis-header').forEach(header => {
                header.addEventListener('click', function () {
                    const content = this.nextElementSibling;
                    content.classList.toggle('show');
                    const toggle = this.querySelector('.mybatis-toggle');
                    toggle.textContent = content.classList.contains('show') ? 'â–²' : 'â–¼';
                });
            });
        }

        // æ¸²æŸ“æ—¥å¿—åˆ—è¡¨
        function renderLogs(logs) {
            const logsList = document.getElementById('logsList');
            let html = '';

            logs.forEach((log, index) => {
                const timestamp = log._source['@timestamp'] || 'æœªçŸ¥æ—¶é—´';
                const logContent = log._source.log || '';
                const namespace = log._source.kubernetes?.namespace || '';
                const pod = log._source.kubernetes?.pod?.name || '';

                // ç¡®å®šæ—¥å¿—çº§åˆ«ï¼ˆæ ¹æ®å†…å®¹ç®€å•åˆ¤æ–­ï¼‰
                let logLevelClass = '';
                if (logContent.toLowerCase().includes('error') || logContent.toLowerCase().includes('exception')) {
                    logLevelClass = 'log-level-error';
                } else if (logContent.toLowerCase().includes('warn')) {
                    logLevelClass = 'log-level-warning';
                } else if (logContent.toLowerCase().includes('debug')) {
                    logLevelClass = 'log-level-debug';
                } else {
                    logLevelClass = 'log-level-info';
                }

                // æ ¼å¼åŒ–æ—¥å¿—å†…å®¹
                const formattedContent = formatLogContent(logContent);

                html += `
                    <div class="log-entry" data-log-index="${index}">
                        <div class="log-header">
                            <div class="log-timestamp">
                                ${formatTimestamp(timestamp)}
                                <button class="json-btn" onclick="showLogAsJson(${index})">JSON</button>
                            </div>
                            <div class="log-metadata">${namespace}/${pod}</div>
                        </div>
                        <div class="log-content ${logLevelClass}">${formattedContent}</div>
                    </div>
                `;
            });

            logsList.innerHTML = html;
        }

        // æå–å¹¶æ˜¾ç¤ºæ—¥å¿—ä¸­çš„é”®å€¼å¯¹ä¸º JSON æ ¼å¼
        function showLogAsJson(index) {
            if (!currentLogs || !currentLogs[index]) {
                alert('æ— æ³•è·å–æ—¥å¿—æ•°æ®');
                return;
            }

            const log = currentLogs[index];
            const logContent = log._source.log || '';

            // å°è¯•æå–é”®å€¼å¯¹éƒ¨åˆ†å¹¶è½¬æ¢ä¸º JSON
            const jsonData = extractKeyValuePairs(logContent);

            // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤º JSON
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 8px;
                max-width: 85%;
                max-height: 85%;
                overflow: auto;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            `;

            const title = document.createElement('h3');
            title.textContent = jsonData.success ? `JSON æ ¼å¼æ•°æ® (ç´¢å¼•: ${index})` : `åŸå§‹æ—¥å¿— (ç´¢å¼•: ${index})`;
            title.style.cssText = 'margin: 0 0 15px 0; color: #333;';

            const logDiv = document.createElement('div');
            logDiv.style.cssText = `
                background-color: #f5f5f5;
                padding: 15px;
                border-radius: 4px;
                overflow-x: auto;
                font-family: 'Monaco', 'Menlo', monospace;
                font-size: 13px;
                line-height: 1.6;
                margin: 0 0 15px 0;
                white-space: pre-wrap;
                word-break: break-word;
            `;

            if (jsonData.success) {
                // æ˜¾ç¤ºæ ¼å¼åŒ–çš„ JSON
                logDiv.innerHTML = highlightJson(jsonData.json);
            } else {
                // å¦‚æœæå–å¤±è´¥ï¼Œæ˜¾ç¤ºåŸå§‹å†…å®¹
                logDiv.textContent = logContent;
            }

            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = 'display: flex; gap: 10px; justify-content: flex-end;';

            const copyBtn = document.createElement('button');
            copyBtn.textContent = jsonData.success ? 'å¤åˆ¶ JSON' : 'å¤åˆ¶åŸå§‹å†…å®¹';
            copyBtn.style.cssText = `
                background-color: #1890ff;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
            `;
            copyBtn.onclick = () => {
                const copyText = jsonData.success ? jsonData.json : logContent;
                navigator.clipboard.writeText(copyText).then(() => {
                    copyBtn.textContent = 'å·²å¤åˆ¶!';
                    setTimeout(() => copyBtn.textContent = jsonData.success ? 'å¤åˆ¶ JSON' : 'å¤åˆ¶åŸå§‹å†…å®¹', 2000);
                });
            };

            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'å…³é—­';
            closeBtn.style.cssText = `
                background-color: #d9d9d9;
                color: #333;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
            `;
            closeBtn.onclick = () => document.body.removeChild(modal);

            buttonContainer.appendChild(copyBtn);
            buttonContainer.appendChild(closeBtn);

            content.appendChild(title);
            content.appendChild(logDiv);
            content.appendChild(buttonContainer);
            modal.appendChild(content);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };

            document.body.appendChild(modal);
        }

        // é€’å½’è§£æ JSON å­—ç¬¦ä¸²
        function recursiveParseJson(obj) {
            if (typeof obj === 'string') {
                // å°è¯•è§£æå­—ç¬¦ä¸²ä¸º JSON
                try {
                    const parsed = JSON.parse(obj);
                    // é€’å½’è§£æ
                    return recursiveParseJson(parsed);
                } catch (e) {
                    // ä¸æ˜¯ JSONï¼Œè¿”å›åŸå€¼
                    return obj;
                }
            } else if (Array.isArray(obj)) {
                // é€’å½’å¤„ç†æ•°ç»„
                return obj.map(item => recursiveParseJson(item));
            } else if (obj !== null && typeof obj === 'object') {
                // é€’å½’å¤„ç†å¯¹è±¡
                const result = {};
                for (const key in obj) {
                    result[key] = recursiveParseJson(obj[key]);
                }
                return result;
            }
            return obj;
        }

        // è§£æ Java å¯¹è±¡æ ¼å¼ä¸º JSONï¼ˆå¦‚ï¼šTestLabNote(key=value, key2=value2)ï¼‰
        function parseJavaObjectToJson(content) {
            try {
                // æŸ¥æ‰¾æœ€åä¸€ä¸ª "] - " ä¹‹åçš„å†…å®¹
                const match = content.match(/\]\s*-\s*(.+)$/);
                if (!match) return null;

                const kvPart = match[1].trim();

                // æ£€æŸ¥æ˜¯å¦åŒ…å« Java å¯¹è±¡æ ¼å¼çš„ç‰¹å¾
                if (!kvPart.includes('(') || !kvPart.includes('=')) {
                    return null;
                }

                const obj = {};

                // åŒ¹é…ç®€å•çš„ key: value æ ¼å¼
                const simpleKvRegex = /(\w+):\s*([^,\[]+?)(?=,\s*\w+:|$)/g;
                let match1;
                while ((match1 = simpleKvRegex.exec(kvPart)) !== null) {
                    const key = match1[1];
                    let value = match1[2].trim();

                    // å¤„ç†å€¼ç±»å‹
                    if (value === 'null') {
                        obj[key] = null;
                    } else if (value === 'true') {
                        obj[key] = true;
                    } else if (value === 'false') {
                        obj[key] = false;
                    } else if (/^\d+$/.test(value)) {
                        obj[key] = parseInt(value);
                    } else if (/^\d+\.\d+$/.test(value)) {
                        obj[key] = parseFloat(value);
                    } else {
                        obj[key] = value;
                    }
                }

                // åŒ¹é…æ•°ç»„æ ¼å¼ key: [...]
                const arrayRegex = /(\w+):\s*(\[[\s\S]*?\](?=,?\s*(?:\w+:|$)))/g;
                let match2;
                while ((match2 = arrayRegex.exec(kvPart)) !== null) {
                    const key = match2[1];
                    const arrayStr = match2[2];

                    // è§£ææ•°ç»„ä¸­çš„ Java å¯¹è±¡
                    const items = [];

                    // åŒ¹é… ClassName(...) æ ¼å¼
                    const objectRegex = /(\w+)\((.*?)\)(?=,\s*\w+\(|])/g;
                    let objMatch;

                    let lastIndex = 0;
                    while ((objMatch = objectRegex.exec(arrayStr)) !== null) {
                        const className = objMatch[1];
                        const propsStr = objMatch[2];

                        const item = { _type: className };

                        // è§£æå¯¹è±¡å±æ€§ key=value
                        const propRegex = /(\w+)=((?:[^,()]+|\([^)]*\))+?)(?=,\s*\w+=|$)/g;
                        let propMatch;

                        while ((propMatch = propRegex.exec(propsStr)) !== null) {
                            let propKey = propMatch[1];
                            let propValue = propMatch[2].trim();

                            // å¤„ç†åµŒå¥—å¯¹è±¡ super=ClassName(...)
                            if (propValue.includes('(') && propValue.includes(')')) {
                                const nestedMatch = propValue.match(/(\w+)\((.*)\)/);
                                if (nestedMatch) {
                                    const nestedObj = { _type: nestedMatch[1] };
                                    const nestedProps = nestedMatch[2];
                                    const nestedPropRegex = /(\w+)=([^,]+)/g;
                                    let nestedPropMatch;
                                    while ((nestedPropMatch = nestedPropRegex.exec(nestedProps)) !== null) {
                                        let nk = nestedPropMatch[1];
                                        let nv = nestedPropMatch[2].trim();
                                        if (nv === 'null') nestedObj[nk] = null;
                                        else if (nv === 'true') nestedObj[nk] = true;
                                        else if (nv === 'false') nestedObj[nk] = false;
                                        else if (/^\d+$/.test(nv)) nestedObj[nk] = parseInt(nv);
                                        else nestedObj[nk] = nv;
                                    }
                                    item[propKey] = nestedObj;
                                }
                            } else {
                                // ç®€å•å€¼
                                if (propValue === 'null') {
                                    item[propKey] = null;
                                } else if (propValue === 'true') {
                                    item[propKey] = true;
                                } else if (propValue === 'false') {
                                    item[propKey] = false;
                                } else if (/^\d+$/.test(propValue)) {
                                    item[propKey] = parseInt(propValue);
                                } else if (/^\d+\.\d+$/.test(propValue)) {
                                    item[propKey] = parseFloat(propValue);
                                } else {
                                    item[propKey] = propValue;
                                }
                            }
                        }

                        items.push(item);
                        lastIndex = objMatch.index + objMatch[0].length;
                    }

                    if (items.length > 0) {
                        obj[key] = items;
                    }
                }

                if (Object.keys(obj).length > 0) {
                    return obj;
                }

                return null;
            } catch (error) {
                console.error('Failed to parse Java object:', error);
                return null;
            }
        }

        // æå–æ—¥å¿—ä¸­çš„ JSON æ•°æ®
        function extractKeyValuePairs(logContent) {
            try {
                // æ–¹æ³•1ï¼šå°è¯•ç›´æ¥è§£ææ•´ä¸ªå†…å®¹ä¸º JSON
                try {
                    const parsed = JSON.parse(logContent);
                    const recursiveParsed = recursiveParseJson(parsed);
                    const jsonString = JSON.stringify(recursiveParsed, null, 2);
                    return { success: true, json: jsonString, obj: recursiveParsed };
                } catch (e) {
                    // ä¸æ˜¯ç›´æ¥çš„ JSONï¼Œç»§ç»­å°è¯•å…¶ä»–æ–¹æ³•
                }

                // æ–¹æ³•2ï¼šæŸ¥æ‰¾ JSON å¯¹è±¡ï¼ˆä»¥ { å¼€å¤´ï¼‰
                const jsonMatch = logContent.match(/\{[\s\S]*\}$/);
                if (jsonMatch) {
                    try {
                        const parsed = JSON.parse(jsonMatch[0]);
                        const recursiveParsed = recursiveParseJson(parsed);
                        const jsonString = JSON.stringify(recursiveParsed, null, 2);
                        return { success: true, json: jsonString, obj: recursiveParsed };
                    } catch (e) {
                        console.error('Failed to parse JSON:', e);
                    }
                }

                // æ–¹æ³•3ï¼šæŸ¥æ‰¾æœ€åä¸€ä¸ª "] - " æˆ– "INFO" ç­‰ä¹‹åçš„å†…å®¹
                const patterns = [
                    /\]\s*-\s*(\{[\s\S]*\})$/,  // ] - {...}
                    /INFO\s+(\{[\s\S]*\})$/,     // INFO {...}
                    /DEBUG\s+(\{[\s\S]*\})$/,    // DEBUG {...}
                    /WARN\s+(\{[\s\S]*\})$/,     // WARN {...}
                    /ERROR\s+(\{[\s\S]*\})$/     // ERROR {...}
                ];

                for (const pattern of patterns) {
                    const match = logContent.match(pattern);
                    if (match) {
                        try {
                            const parsed = JSON.parse(match[1]);
                            const recursiveParsed = recursiveParseJson(parsed);
                            const jsonString = JSON.stringify(recursiveParsed, null, 2);
                            return { success: true, json: jsonString, obj: recursiveParsed };
                        } catch (e) {
                            continue;
                        }
                    }
                }

                // æ–¹æ³•4ï¼šå°è¯•è§£æ Java å¯¹è±¡æ ¼å¼
                const javaObj = parseJavaObjectToJson(logContent);
                if (javaObj) {
                    const jsonString = JSON.stringify(javaObj, null, 2);
                    return { success: true, json: jsonString, obj: javaObj };
                }

                return { success: false };
            } catch (error) {
                console.error('Failed to extract JSON:', error);
                return { success: false };
            }
        }

        // é«˜äº® JSON è¯­æ³•
        function highlightJson(jsonString) {
            let html = escapeHtml(jsonString);

            // ä½¿ç”¨å ä½ç¬¦é¿å…é‡å¤åŒ¹é…
            const placeholder = '\u0000PLACEHOLDER\u0000';
            let placeholders = [];

            // 1. é«˜äº®é”®åå’Œå†’å·ï¼ˆ"key": ï¼‰- ç´«çº¢è‰²é”®å
            html = html.replace(/"([^"]+)"(\s*):/g, (match, key, space) => {
                const index = placeholders.length;
                placeholders.push(`<span style="color: #c41d7f; font-weight: 500;">"${key}"</span>${space}<span style="color: #8c8c8c;">:</span>`);
                return `${placeholder}${index}${placeholder}`;
            });

            // 2. é«˜äº®å­—ç¬¦ä¸²å€¼ï¼ˆç©ºæ ¼"value"ï¼‰- ç»¿è‰²
            html = html.replace(/(\s)"([^"]*)"/g, (match, space, value) => {
                const index = placeholders.length;
                placeholders.push(`${space}<span style="color: #52c41a;">"${value}"</span>`);
                return `${placeholder}${index}${placeholder}`;
            });

            // 3. é«˜äº® null - çº¢è‰²
            html = html.replace(/(\s)(null)\b/g, (match, space, value) => {
                const index = placeholders.length;
                placeholders.push(`${space}<span style="color: #ff4d4f; font-weight: 500;">${value}</span>`);
                return `${placeholder}${index}${placeholder}`;
            });

            // 4. é«˜äº® true, false - è“è‰²
            html = html.replace(/(\s)(true|false)\b/g, (match, space, value) => {
                const index = placeholders.length;
                placeholders.push(`${space}<span style="color: #1890ff; font-weight: 500;">${value}</span>`);
                return `${placeholder}${index}${placeholder}`;
            });

            // 5. é«˜äº®æ•°å­— - è“è‰²
            html = html.replace(/(\s)(-?\d+\.?\d*)\b/g, (match, space, value) => {
                const index = placeholders.length;
                placeholders.push(`${space}<span style="color: #1890ff; font-weight: 500;">${value}</span>`);
                return `${placeholder}${index}${placeholder}`;
            });

            // 6. é«˜äº®æ‹¬å· - æ·±ç°è‰²
            html = html.replace(/([{}[\]])/g, (match) => {
                const index = placeholders.length;
                placeholders.push(`<span style="color: #595959; font-weight: 500;">${match}</span>`);
                return `${placeholder}${index}${placeholder}`;
            });

            // 7. é«˜äº®é€—å· - æµ…ç°è‰²
            html = html.replace(/(,)/g, (match) => {
                const index = placeholders.length;
                placeholders.push(`<span style="color: #8c8c8c;">${match}</span>`);
                return `${placeholder}${index}${placeholder}`;
            });

            // è¿˜åŸæ‰€æœ‰å ä½ç¬¦
            for (let i = 0; i < placeholders.length; i++) {
                html = html.replace(`${placeholder}${i}${placeholder}`, placeholders[i]);
            }

            return html;
        }


        // æ ¼å¼åŒ–æ—¥å¿—å†…å®¹
        function formatLogContent(content) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯ MyBatis æ—¥å¿—
            const isMyBatisLog = content.includes('Preparing:') ||
                content.includes('Parameters:') ||
                content.includes('org.apache.ibatis') ||
                content.includes('==>  Preparing:') ||
                content.includes('==> Parameters:');

            // å¦‚æœæ˜¯ MyBatis æ—¥å¿—ï¼Œä½¿ç”¨æŠ˜å å®¹å™¨
            if (isMyBatisLog) {
                return formatMyBatisLog(content);
            }

            // è½¬ä¹‰HTML
            let escapedContent = escapeHtml(content);

            // è·å–æœç´¢è¯
            const searchTerm = document.getElementById('searchTerm').value;

            // å¯¹æœç´¢è¯è¿›è¡Œé«˜äº®
            if (searchTerm) {
                escapedContent = highlightSearchTerm(escapedContent, searchTerm);
            }

            // å¤„ç†JSONæ—¥å¿—
            escapedContent = formatJsonLogs(escapedContent);

            return escapedContent;
        }

        // é«˜äº® MyBatis æ—¥å¿—ä¸­çš„ SQL è¯­å¥
        function highlightMyBatisSql(content) {
            // å…ˆè½¬ä¹‰ HTML
            let result = escapeHtml(content);

            // ä½¿ç”¨å ä½ç¬¦é¿å…é‡å¤åŒ¹é…
            const placeholder = '\u0000SQLPLACEHOLDER\u0000';
            let sqlStatements = [];

            // è§„åˆ™ï¼šæ‰¾åˆ° "Preparing:" åé¢çš„å†…å®¹ç›´åˆ°è¡Œå°¾ï¼Œè¿™å°±æ˜¯ SQL è¯­å¥
            result = result.replace(/(.*?Preparing:\s*)(.+?)(?=\n|$)/g, (match, prefix, sql) => {
                const index = sqlStatements.length;
                // SQL è¯­å¥ç”¨èƒŒæ™¯è‰²å’Œè¾¹æ¡†é«˜äº®æ˜¾ç¤º
                sqlStatements.push(`${prefix}<span style="background-color: #e6f7ff; color: #0050b3; padding: 2px 4px; border-radius: 3px; border-left: 3px solid #1890ff; display: inline-block; font-weight: 500;">${sql}</span>`);
                return `${placeholder}${index}${placeholder}`;
            });

            // è¿˜åŸæ‰€æœ‰å ä½ç¬¦
            for (let i = 0; i < sqlStatements.length; i++) {
                result = result.replace(`${placeholder}${i}${placeholder}`, sqlStatements[i]);
            }

            return result;
        }

        // æ ¼å¼åŒ– MyBatis æ—¥å¿—ä¸ºæŠ˜å å®¹å™¨
        function formatMyBatisLog(content) {
            // å…ˆé«˜äº® SQL è¯­å¥
            let processedContent = highlightMyBatisSql(content);

            // è·å–æœç´¢è¯
            const searchTerm = document.getElementById('searchTerm').value;

            // å¯¹æœç´¢è¯è¿›è¡Œé«˜äº®
            if (searchTerm) {
                processedContent = highlightSearchTerm(processedContent, searchTerm);
            }

            // æå–ç¬¬ä¸€è¡Œä½œä¸ºæ ‡é¢˜ï¼ˆæ˜¾ç¤ºå®Œæ•´çš„ä¸€è¡Œï¼‰
            const lines = content.split('\n');
            const title = escapeHtml(lines[0]);

            return `
                <div class="mybatis-container">
                    <div class="mybatis-header">
                        <span class="mybatis-header-text">MyBatis SQL - ${title}</span>
                        <span class="mybatis-toggle">â–¼</span>
                    </div>
                    <div class="mybatis-content">
                        ${processedContent}
                    </div>
                </div>
            `;
        }


        // æœç´¢è¯é«˜äº®
        function highlightSearchTerm(content, searchTerm) {
            if (!searchTerm) return content;

            // è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
            const escapedTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedTerm})`, 'gi');

            return content.replace(regex, '<span class="highlight">$1</span>');
        }

        // æ ¼å¼åŒ–JSONæ—¥å¿—ï¼ˆç®€åŒ–ç‰ˆï¼Œä¸ä½¿ç”¨æŠ˜å å®¹å™¨ï¼‰
        function formatJsonLogs(content) {
            // ç›´æ¥è¿”å›å†…å®¹ï¼Œä¸åšç‰¹æ®Šå¤„ç†
            return content;
        }

        // å¯¼å‡ºæ—¥å¿—å‡½æ•°ï¼ˆå¯¼å‡ºå½“å‰é¡µé¢æ˜¾ç¤ºçš„æ—¥å¿—ï¼‰
        function exportLogs(format) {
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ—¥å¿—æ•°æ®
                if (!currentLogs || currentLogs.length === 0) {
                    alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ—¥å¿—æ•°æ®ï¼Œè¯·å…ˆæœç´¢æ—¥å¿—ï¼');
                    return;
                }

                let content = '';
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

                if (format === 'txt') {
                    // TXTæ ¼å¼ï¼šçº¯æ–‡æœ¬
                    currentLogs.forEach((log, index) => {
                        const logTimestamp = log._source['@timestamp'] || 'æœªçŸ¥æ—¶é—´';
                        const logContent = log._source.log || '';
                        const namespace = log._source.kubernetes?.namespace || '';
                        const pod = log._source.kubernetes?.pod?.name || '';

                        content += `========== æ—¥å¿— ${index + 1} ==========\n`;
                        content += `æ—¶é—´: ${logTimestamp}\n`;
                        content += `å‘½åç©ºé—´/Pod: ${namespace}/${pod}\n`;
                        content += `å†…å®¹:\n${logContent}\n\n`;
                    });
                } else if (format === 'json') {
                    // JSONæ ¼å¼ï¼šä¿æŒåŸå§‹ç»“æ„
                    content = JSON.stringify(currentLogs, null, 2);
                }

                // åˆ›å»º Blob å¹¶ä¸‹è½½
                const blob = new Blob([content], {
                    type: format === 'json' ? 'application/json' : 'text/plain;charset=utf-8;'
                });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `logs_${timestamp}.${format}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                console.log(`æˆåŠŸå¯¼å‡º ${currentLogs.length} æ¡æ—¥å¿—`);
            } catch (error) {
                console.error('å¯¼å‡ºæ—¥å¿—æ—¶å‡ºé”™:', error);
                alert(`å¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´æˆ³
        function formatTimestamp(timestamp) {
            try {
                const date = new Date(timestamp);
                return date.toLocaleString('zh-CN');
            } catch (e) {
                return timestamp;
            }
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>